name: setup-node
description: "Setup Node.js ⚙️ - Cache dependencies ⚡ - Install dependencies 🔧"
runs:
  using: "composite"
  steps:
    - name: Setup Node.js ⚙️
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Romve node_modules 🧹
      run: rm -rf node_modules && rm -f package-lock.json

    - name: Cache dependencies ⚡
      id: cache_dependencies
      uses: actions/cache@v3
      with:
        path: node_modules
        key: node-modules-${{ hashFiles('package-lock.json') }}

    - name: Install dependencies 🔧
      shell: bash
      if: steps.cache_dependencies.outputs.cache-hit != 'true'
      run: npm ci

    - name: Validate JSON files 📋
      shell: bash
      run: |
        find . -type f -name "*.json" -exec echo "Validating {}" \; -exec jq empty {} \;

    - name: Build with detailed logging 🏗️
      shell: bash
      run: |
        export NODE_OPTIONS="--max-old-space-size=4096"
        npm run build || {
          echo "Build failed. Checking for common issues..."
          echo "Contents of .next/server directory:"
          ls -la .next/server || true
          echo "Last 100 lines of build log:"
          tail -n 100 .next/build-manifest.json || true
          exit 1
        }

    - name: Type check 📝
      shell: bash
      run: npm run type-check || true